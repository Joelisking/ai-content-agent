# AI Architecture & Workflow Walkthrough

This document provides a deep dive into the AI-native architecture of the system. It moves beyond standard web app patterns to explain how the system functions as an autonomous, controlled agent.

## 1. Core Concept: The "Agentic" Workflow

Unlike a simple "wrapper" that sends one prompt to ChatGPT, this system implements a **Chain-of-Thought Agent**. The generation process is broken into distinct, observable steps. This ensures higher quality, easier debugging, and better adherence to brand guidelines.

### The 3-Step Reasoning Chain

The `AIAgentService` (`backend/src/services/aiAgent.service.ts`) orchestrates this flow:

#### Step 1: Brand Voice Analysis

**Objective**: "Ground" the model in the specific brand's context before asking it to write anything.

- **Input**: Brand guidelines (Tone: "Witty", Key Messages: "Innovation").
- **Action**: The agent acts as a "Brand Strategist" to analyze these inputs.
- **Why?** This prevents generic "AI-sounding" content by forcing the model to first internalize the specific persona.

#### Step 2: Content Generation

**Objective**: Draft the actual post using the context from Step 1.

- **Input**:
  - `Brand Context` (Output of Step 1)
  - `Platform Guidelines` (Hardcoded best practices for LinkedIn/IG)
  - `Media Context` (What is in the image?)
  - `Previous Posts` (To avoid repetition)
- **Prompt Logic**:
  > "You are a social media creator. Using ONLY the brand voice defined above..."
  > "CRITICAL INSTRUCTION: You must avoid the themes... used in these recent posts."
- **Why?** By feeding the Step 1 output into Step 2, we ensure consistency. Passing previous posts prevents the "repetitive phrasing" common in AI.

#### Step 3: Optimization

**Objective**: Maximize reach with metadata.

- **Action**: Extracts or generates SEO-optimized hashtags based specifically on the drafted text.
- **Why?** decoupling this allows us to use different logic (or even different models) for metadata vs. creative text.

---

## 2. State & Lifecycle Management

The system treats content creation as a **Finite State Machine (FSM)**. This is crucial for safetyâ€”an AI cannot "accidentally" post something.

### The Lifecycle

1.  **PENDING**: Content is generated by AI. It exists but is invisible to the public.
    - _Controls_: Can be Regnerated, Edited, Rejected, or Approved.
2.  **APPROVED**: A human has explicitly signed off.
    - _Controls_: Can be Scheduled or Posted Immediately.
3.  **SCHEDULED**: Waiting for the cron job to pick it up.
    - _Controls_: Can be moved back to Pending (un-approved).
4.  **POSTED**: Terminal state.
    - _Controls_: Link to live URL stored.

### Safety Enforcements

- **Hard Gate**: The `PostingService` throws an error if `status !== 'approved'`. No API call can bypass this.
- **Audit Trail**: Every state transition is logged in `AuditLogs` (e.g., "User X moved Item Y to Approved").

---

## 3. Control Systems (The "Kill Switch")

A production AI system needs operational safeguards. We implemented a **System Control Layer** that overrides all other logic.

### Control Modes

The `SystemControl` model acts as a global traffic light:

| Mode            | Behavior                                                               | Use Case                                                   |
| :-------------- | :--------------------------------------------------------------------- | :--------------------------------------------------------- |
| **ACTIVE**      | Normal operation. Cron job runs. Manual posting allowed.               | Standard daily operation.                                  |
| **PAUSED**      | **Cron Job Skips**. No auto-posting. Manual posting still allowed.     | Maintenance or low-monitoring periods.                     |
| **MANUAL-ONLY** | **Cron Job Skips**. AI generates drafts, but humans must click "Post". | Testing new prompts or distrust in current AI performance. |
| **CRISIS**      | **TOTAL LOCKDOWN**. All posting API calls throw errors.                | PR disaster or major bug.                                  |

### Implementation Detail

In `posting.service.ts`:

```typescript
// Inside publishContent()
const systemControl = await SystemControl.findOne();
if (systemControl.mode === 'crisis') {
  throw new Error('System in crisis mode - posting blocked');
}
```

This check happens **milliseconds** before the external API call, ensuring that even if a UI button is clicked "in time", the backend will reject it if the mode changed.

---

## 4. Multi-Modal Intelligence

The agent isn't text-only. It intelligently handles media:

- **Image Analysis**: If you upload a photo, the agent (using `claude-3-haiku` vision) first "sees" the image to generate a description.
- **Context Injection**: This description is injected into the Step 2 prompt.
  - _Result_: The caption actually relates to the image (e.g., "Look at this beautiful sunset..." vs generic "Here is a photo").

---

## 5. Summary of Design Decisions

| Feature      | Design Decision     | Why?                                                                                 |
| :----------- | :------------------ | :----------------------------------------------------------------------------------- |
| **Model**    | Anthropic Claude    | Better at following complex, multi-step instructions than generic GPT-3.5.           |
| **Queue**    | Node-cron (Polling) | Simple to implement for MVP. Easy to upgrade to Redis/BullMQ for scale.              |
| **Database** | MongoDB             | Flexible schema allows adding new platforms (TikTok/Reels) without migrations.       |
| **Frontend** | React + Shadcn UI   | Provides a "Dashboard" feel appropriate for Admin tools, not just a document viewer. |

This architecture prioritizes **Safety**, **Observability**, and **Brand Consistency** over raw speed, making it suitable for business use cases.
